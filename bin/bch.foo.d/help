#!/usr/bin/env python3
import sys
import os
from pathlib import Path

here = Path(__file__).parent
ZERO = Path(os.environ[ '__BCH_ZERO' ])
CMD = os.environ[ '__BCH_NAME' ]
DDD=Path(str(ZERO)+'.d')
SSS=Path(str(ZERO)+'.s')


def ok(path):
    if path.name.startswith('_'): return False
    if path.name.endswith('_'): return False
    if path.is_dir(): return False
    if not path.is_file(): return False
    return True


def doc4sub(sub):
    target=Path(str(sub)+'.__doc__')
    if target.is_file():
        return target.read_text()
    return ''

def short4sub(sub):
    return doc4sub(sub).split('\n')[0] 

def main():
    if len(sys.argv)<2:
        root_help()
    else:
        subhelp()

def subhelp():
    subname=sys.argv[1]
    subs = [DDD/subname, SSS/subname]
    subs = [ sub for sub in subs if ok(sub) ]

    if not subs:
        print("%s: no help for '%s'" % (CMD,subname))
        exit()
    for sub in subs:
        if sub.parent == DDD: print("\nUSAGE: %s %s\n" % (CMD, sub.name))
        if sub.parent == SSS: print("\nUSAGE: . %s %s\n" % (CMD, sub.name))
        doc = doc4sub(sub)
        if doc:
            for line in doc.split('\n'):
                print( '    ' + line )


def root_help():
    print( 'USAGE:')
    acc={}
    for sub in list(DDD.glob('*')) + list( SSS.glob('*')):
        if not ok(sub): 
            continue
        doc=short4sub(sub)
        if sub.parent == DDD: print("      %s %s" % (CMD, sub.name))
        if sub.parent == SSS: print("    . %s %s" % (CMD, sub.name))
        if doc:
            print( "           ", doc )


if __name__ == '__main__':
    main()
